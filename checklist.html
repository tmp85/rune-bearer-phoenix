<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rune Bearer Schedule Tracker</title>
    <style>
        :root {
            --primary-purple: #8b5cf6;
            --secondary-purple: #a78bfa;
            --dark-purple: #6d28d9;
            --success-green: #10b981;
            --warning-orange: #f59e0b;
            --text-light: #f8fafc;
            --text-gray: #64748b;
            --bg-dark: #1e293b;
            --bg-darker: #0f172a;
            --border-color: rgba(139, 92, 246, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--bg-darker), var(--bg-dark));
            color: var(--text-light);
            min-height: 100vh;
            line-height: 1.6;
        }

        .header {
            text-align: center;
            padding: 2rem;
            background: linear-gradient(135deg, var(--primary-purple), var(--secondary-purple));
            box-shadow: 0 4px 20px rgba(139, 92, 246, 0.3);
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .progress-summary {
            display: flex;
            justify-content: center;
            gap: 2rem;
            padding: 1.5rem;
            background: rgba(139, 92, 246, 0.1);
            border-bottom: 1px solid var(--border-color);
        }

        .progress-item {
            text-align: center;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            min-width: 150px;
        }

        .progress-number {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary-purple);
        }

        .progress-label {
            font-size: 0.9rem;
            color: var(--text-gray);
            margin-top: 0.5rem;
        }

        .admin-controls {
            display: flex;
            justify-content: center;
            gap: 1rem;
            padding: 1rem;
            background: rgba(0, 0, 0, 0.2);
        }

        .admin-btn {
            padding: 0.75rem 1.5rem;
            background: linear-gradient(135deg, var(--dark-purple), var(--primary-purple));
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .admin-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4);
        }

        .admin-btn.reset {
            background: linear-gradient(135deg, #dc2626, #ef4444);
        }

        .table-container {
            margin: 0 auto;
            max-width: 1400px;
            padding: 2rem;
            overflow-x: auto;
        }

        .schedule-table {
            width: 100%;
            border-collapse: collapse;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .schedule-table th {
            background: linear-gradient(135deg, var(--dark-purple), var(--primary-purple));
            color: white;
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid var(--border-color);
        }

        .schedule-table td {
            padding: 0.75rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            transition: background-color 0.3s ease;
        }

        .schedule-table tr:hover {
            background: rgba(139, 92, 246, 0.1);
        }

        .day-row.completed {
            background: rgba(16, 185, 129, 0.2);
        }

        .day-row.locked {
            background: rgba(100, 116, 139, 0.2);
            opacity: 0.6;
        }

        .character-section {
            margin-bottom: 0.5rem;
            padding: 0.5rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            border-left: 3px solid transparent;
        }

        .character-section.wells {
            border-left-color: var(--warning-orange);
        }

        .character-section.rou {
            border-left-color: #3b82f6;
        }

        .character-name {
            font-weight: bold;
            margin-bottom: 0.25rem;
        }

        .character-info {
            font-size: 0.9rem;
            color: var(--text-gray);
        }

        .completion-checkbox {
            transform: scale(1.2);
            margin-right: 0.5rem;
        }

        .completion-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .status-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status-badge.completed {
            background: var(--success-green);
            color: white;
        }

        .status-badge.locked {
            background: var(--text-gray);
            color: white;
        }

        .status-badge.available {
            background: var(--primary-purple);
            color: white;
        }

        .task-info {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .task-type {
            font-weight: 600;
            color: var(--primary-purple);
        }

        .rune-info {
            font-size: 0.9rem;
        }

        .rune-name {
            color: var(--warning-orange);
            font-weight: 600;
        }

        .loot-tier {
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .loot-tier.tiny {
            background: rgba(139, 92, 246, 0.3);
            color: var(--secondary-purple);
        }

        .loot-tier.medium {
            background: rgba(245, 158, 11, 0.3);
            color: var(--warning-orange);
        }

        .loot-tier.big {
            background: rgba(16, 185, 129, 0.3);
            color: var(--success-green);
        }

        .special-room {
            color: var(--warning-orange);
            font-weight: 600;
        }

        /* Day Activation Controls */
        .activation-controls {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            align-items: center;
        }

        .activation-toggle {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .activation-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .activation-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #64748b;
            transition: .4s;
            border-radius: 34px;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }

        .activation-slider:before {
            position: absolute;
            content: "";
            height: 24px;
            width: 24px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        .activation-toggle input:checked + .activation-slider {
            background-color: var(--success-green);
        }

        .activation-toggle input:checked + .activation-slider:before {
            transform: translateX(26px);
        }

        .activation-toggle.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .activation-toggle.disabled .activation-slider {
            cursor: not-allowed;
            background-color: #374151;
        }

        .activation-label {
            font-size: 0.8rem;
            text-align: center;
            margin-top: 0.25rem;
            font-weight: 600;
        }

        .activation-label.active {
            color: var(--success-green);
        }

        .activation-label.inactive {
            color: var(--text-gray);
        }

        .activation-label.disabled {
            color: #6b7280;
        }

        .prerequisite-warning {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid var(--warning-orange);
            color: var(--warning-orange);
            padding: 0.5rem;
            border-radius: 6px;
            font-size: 0.8rem;
            text-align: center;
            margin: 0.25rem 0;
        }

        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: var(--bg-darker);
            color: var(--text-light);
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            border: 1px solid var(--border-color);
            font-size: 0.75rem;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .tooltip .tooltiptext::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: var(--bg-darker) transparent transparent transparent;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }

            .progress-summary {
                flex-direction: column;
                gap: 1rem;
            }

            .admin-controls {
                flex-direction: column;
                align-items: center;
            }

            .table-container {
                padding: 1rem;
            }

            .schedule-table th,
            .schedule-table td {
                padding: 0.5rem;
                font-size: 0.9rem;
            }

            .activation-toggle {
                width: 50px;
                height: 28px;
            }

            .activation-slider:before {
                height: 20px;
                width: 20px;
                left: 2px;
                bottom: 2px;
            }

            .activation-toggle input:checked + .activation-slider:before {
                transform: translateX(22px);
            }

                    .tooltip .tooltiptext {
            width: 150px;
            margin-left: -75px;
            font-size: 0.7rem;
        }
    }

    /* Reset Panel Styles */
    .reset-panel {
        background: rgba(0, 0, 0, 0.4);
        margin: 1rem auto;
        max-width: 1400px;
        border-radius: 12px;
        border: 2px solid #dc2626;
        box-shadow: 0 8px 32px rgba(220, 38, 38, 0.3);
        animation: slideDown 0.3s ease;
    }

    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .reset-header {
        background: linear-gradient(135deg, #dc2626, #ef4444);
        padding: 1.5rem;
        border-radius: 10px 10px 0 0;
        text-align: center;
    }

    .reset-header h2 {
        margin-bottom: 0.5rem;
        font-size: 1.8rem;
    }

    .reset-controls {
        display: flex;
        justify-content: center;
        gap: 1rem;
        padding: 1rem;
        background: rgba(255, 255, 255, 0.05);
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        flex-wrap: wrap;
    }

    .reset-btn {
        padding: 0.5rem 1rem;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
        background: linear-gradient(135deg, var(--dark-purple), var(--primary-purple));
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .reset-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4);
    }

    .reset-btn.warning {
        background: linear-gradient(135deg, #f59e0b, #fbbf24);
    }

    .reset-btn.danger {
        background: linear-gradient(135deg, #dc2626, #ef4444);
    }

    .reset-weeks-container {
        padding: 1.5rem;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1.5rem;
    }

    .reset-week {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 12px;
        padding: 1rem;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .reset-week-header {
        text-align: center;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .reset-week-title {
        font-size: 1.2rem;
        font-weight: bold;
        color: var(--primary-purple);
        margin-bottom: 0.25rem;
    }

    .reset-week-range {
        font-size: 0.9rem;
        color: var(--text-gray);
    }

    .reset-days-grid {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 0.5rem;
    }

    .reset-day-btn {
        padding: 0.5rem;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.8rem;
        font-weight: 600;
        transition: all 0.3s ease;
        position: relative;
        display: flex;
        flex-direction: column;
        align-items: center;
        min-height: 60px;
        justify-content: center;
    }

    .reset-day-btn.locked {
        background: linear-gradient(135deg, #64748b, #94a3b8);
        color: white;
        opacity: 0.6;
        cursor: not-allowed;
    }

    .reset-day-btn.unlocked {
        background: linear-gradient(135deg, var(--dark-purple), var(--primary-purple));
        color: white;
    }

    .reset-day-btn.completed {
        background: linear-gradient(135deg, #059669, #10b981);
        color: white;
    }

    .reset-day-btn:not(.locked):hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4);
    }

    .reset-day-btn.completed:hover {
        box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
    }

    .day-number {
        font-size: 1rem;
        font-weight: bold;
    }

    .day-status {
        font-size: 0.7rem;
        margin-top: 0.25rem;
        opacity: 0.9;
    }

    .reset-week-controls {
        margin-top: 1rem;
        text-align: center;
        padding-top: 1rem;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
    }

    .reset-week-btn {
        padding: 0.4rem 0.8rem;
        background: linear-gradient(135deg, #dc2626, #ef4444);
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.8rem;
        font-weight: 600;
        transition: all 0.3s ease;
    }

    .reset-week-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 10px rgba(220, 38, 38, 0.4);
    }

    @media (max-width: 768px) {
        .reset-weeks-container {
            grid-template-columns: 1fr;
            padding: 1rem;
        }
        
        .reset-controls {
            flex-direction: column;
            align-items: center;
        }
        
        .reset-days-grid {
            grid-template-columns: repeat(3, 1fr);
        }
    }
    </style>
</head>
<body>
    <div class="header">
        <h1>üè∞ Admin Progress Checklist</h1>
        <p>Manage Wells and Rou's progress through their 40-day adventure</p>
    </div>

    <div class="progress-summary">
        <div class="progress-item">
            <div class="progress-number" id="wellsProgress">0</div>
            <div class="progress-label">Wells Completed</div>
        </div>
        <div class="progress-item">
            <div class="progress-number" id="rouProgress">0</div>
            <div class="progress-label">Rou Completed</div>
        </div>
        <div class="progress-item">
            <div class="progress-number" id="totalProgress">0</div>
            <div class="progress-label">Total Days Unlocked</div>
        </div>
    </div>

    <div class="admin-controls">
        <button class="admin-btn" onclick="window.location.href='index.html'">üéÆ Return to Game</button>
        <button class="admin-btn" onclick="unlockNextDay()">üîì Unlock Next Day</button>
        <button class="admin-btn reset" onclick="resetProgress()">üîÑ Reset All Progress</button>
        <button class="admin-btn" onclick="exportProgress()">üì• Export Progress</button>
        <button class="admin-btn" onclick="toggleResetPanel()">üéØ Reset Individual Days</button>
    </div>

    <!-- Reset Days Panel -->
    <div id="resetPanel" class="reset-panel" style="display: none;">
        <div class="reset-header">
            <h2>üéØ Reset Individual Days</h2>
            <p>Reset specific days back to "never started" state. This will clear all progress, runes, and loot for the selected day.</p>
        </div>
        
        <div class="reset-controls">
            <button class="reset-btn danger" onclick="resetAllProgress()">üîÑ Reset All Progress</button>
            <button class="reset-btn warning" onclick="resetWeek('current')">üìÖ Reset Current Week</button>
            <button class="reset-btn" onclick="toggleResetPanel()">‚ùå Close Panel</button>
        </div>

        <div class="reset-weeks-container">
            <!-- Week blocks will be generated dynamically -->
        </div>
    </div>

    <div class="table-container">
        <table class="schedule-table">
            <thead>
                <tr>
                    <th>Day</th>
                    <th>Date</th>
                    <th>Wells Progress</th>
                    <th>Rou Progress</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="scheduleTableBody">
                <!-- Table rows will be generated dynamically -->
            </tbody>
        </table>
    </div>

    <script src="gameSchedule.js"></script>
    <script>
        // Progress tracking state - SHARED with index.html
        let progressState = {
            currentDay: 1,
            completedDays: [],
            unlockedDays: [1],
            taskCompletions: {},
            collectedRunes: {
                wells: [],
                rou: []
            }
        };

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            loadProgress();
            generateScheduleTable();
            updateProgressSummary();
        });

        // Load progress from localStorage - SHARED KEY
        function loadProgress() {
            const saved = localStorage.getItem('runeBearer_progress');
            if (saved) {
                const data = JSON.parse(saved);
                progressState = {
                    currentDay: data.currentDay || 1,
                    completedDays: data.completedDays || [],
                    unlockedDays: data.unlockedDays || [1],
                    taskCompletions: data.taskCompletions || {},
                    collectedRunes: data.collectedRunes || {
                        wells: [],
                        rou: []
                    }
                };
            }
        }

        // Save progress to localStorage - SHARED KEY
        function saveProgress() {
            localStorage.setItem('runeBearer_progress', JSON.stringify(progressState));
        }

        // Generate the main schedule table
        function generateScheduleTable() {
            const tbody = document.getElementById('scheduleTableBody');
            tbody.innerHTML = '';

            gameSchedule.schedule.forEach(dayData => {
                const row = document.createElement('tr');
                row.className = 'day-row';
                
                // Determine row status using new data structure
                const wellsCompleted = progressState.taskCompletions[`day${dayData.day}_wells`] || false;
                const rouCompleted = progressState.taskCompletions[`day${dayData.day}_rou`] || false;
                const bothCompleted = wellsCompleted && rouCompleted;
                const isLocked = !progressState.unlockedDays.includes(dayData.day);
                
                if (bothCompleted) {
                    row.classList.add('completed');
                } else if (isLocked) {
                    row.classList.add('locked');
                }

                row.innerHTML = `
                    <td>
                        <strong>Day ${dayData.day}</strong><br>
                        <small>${dayData.dayOfWeek}</small>
                    </td>
                    <td>${dayData.date}</td>
                    <td>${generateCharacterCell(dayData.wells, 'wells', dayData.day, isLocked)}</td>
                    <td>${generateCharacterCell(dayData.rou, 'rou', dayData.day, isLocked)}</td>
                    <td>${generateStatusCell(wellsCompleted, rouCompleted, isLocked)}</td>
                    <td>${generateActivationCell(dayData.day, isLocked)}</td>
                `;

                tbody.appendChild(row);
            });
        }

        // Generate character cell content
        function generateCharacterCell(charData, character, day, isLocked) {
            const isCompleted = progressState.taskCompletions[`day${day}_${character}`] || false;
            const checkboxDisabled = isLocked ? 'disabled' : '';
            
            return `
                <div class="character-section ${character}">
                    <div class="completion-status">
                        <input type="checkbox" 
                               class="completion-checkbox" 
                               ${isCompleted ? 'checked' : ''} 
                               ${checkboxDisabled}
                               onchange="handleComplete(${day}, '${character}')">
                        <span class="character-name">${character.charAt(0).toUpperCase() + character.slice(1)}</span>
                    </div>
                    <div class="character-info">
                        <div><strong>${charData.realm}</strong></div>
                        <div class="${charData.isSubBoss || charData.isBoss || charData.isChickenJockey ? 'special-room' : ''}">${charData.room}</div>
                        <div class="task-info">
                            ${charData.irlTask ? `<span class="task-type">IRL: ${charData.irlTask}</span>` : '<span class="task-type">Math Only</span>'}
                            ${charData.runeDropped ? `<div class="rune-info">üîÆ <span class="rune-name">${charData.runeDropped}</span></div>` : ''}
                            ${charData.lootTier && charData.lootTier !== 'None' ? `<span class="loot-tier ${charData.lootTier.toLowerCase()}">${charData.lootTier} Loot</span>` : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        // Generate status cell content
        function generateStatusCell(wellsCompleted, rouCompleted, isLocked) {
            if (isLocked) {
                return '<span class="status-badge locked">üîí Locked</span>';
            } else if (wellsCompleted && rouCompleted) {
                return '<span class="status-badge completed">‚úÖ Complete</span>';
            } else {
                return '<span class="status-badge available">‚≠ê Available</span>';
            }
        }

        // Generate activation control cell content
        function generateActivationCell(day, isLocked) {
            const isActive = progressState.unlockedDays.includes(day);
            const canActivate = canActivateDay(day);
            const isDisabled = !canActivate && !isActive;
            
            let tooltipText = '';
            if (day === 1) {
                tooltipText = 'Day 1 can always be activated';
            } else if (!canActivate && !isActive) {
                tooltipText = `Day ${day - 1} must be activated first`;
            } else if (isActive) {
                tooltipText = `Click to deactivate Day ${day}`;
            } else {
                tooltipText = `Click to activate Day ${day}`;
            }
            
            return `
                <div class="activation-controls">
                    <div class="tooltip">
                        <label class="activation-toggle ${isDisabled ? 'disabled' : ''}">
                            <input type="checkbox" 
                                   ${isActive ? 'checked' : ''} 
                                   ${isDisabled ? 'disabled' : ''}
                                   onchange="handleDayActivation(${day}, this.checked)">
                            <span class="activation-slider"></span>
                        </label>
                        <span class="tooltiptext">${tooltipText}</span>
                    </div>
                    <div class="activation-label ${isActive ? 'active' : (isDisabled ? 'disabled' : 'inactive')}">
                        ${isActive ? 'Active' : (isDisabled ? 'Locked' : 'Inactive')}
                    </div>
                </div>
            `;
        }

        // Check if a day can be activated (sequential rule)
        function canActivateDay(day) {
            if (day === 1) return true; // Day 1 can always be activated
            return progressState.unlockedDays.includes(day - 1); // Previous day must be active
        }

        // Handle day activation/deactivation
        function handleDayActivation(day, isActivating) {
            if (isActivating) {
                // Activating a day
                if (!canActivateDay(day)) {
                    // Show warning and revert checkbox
                    const checkbox = event.target;
                    checkbox.checked = false;
                    
                    // Show warning message
                    const warningDiv = document.createElement('div');
                    warningDiv.className = 'prerequisite-warning';
                    warningDiv.textContent = `Cannot activate Day ${day}. Day ${day - 1} must be activated first.`;
                    warningDiv.style.position = 'fixed';
                    warningDiv.style.top = '20px';
                    warningDiv.style.left = '50%';
                    warningDiv.style.transform = 'translateX(-50%)';
                    warningDiv.style.zIndex = '1000';
                    warningDiv.style.boxShadow = '0 4px 12px rgba(0,0,0,0.3)';
                    
                    document.body.appendChild(warningDiv);
                    
                    // Remove warning after 3 seconds
                    setTimeout(() => {
                        if (warningDiv.parentNode) {
                            warningDiv.parentNode.removeChild(warningDiv);
                        }
                    }, 3000);
                    
                    return;
                }
                
                // Add day to unlocked days
                if (!progressState.unlockedDays.includes(day)) {
                    progressState.unlockedDays.push(day);
                    progressState.unlockedDays.sort((a, b) => a - b);
                    console.log(`Day ${day} manually activated`);
                }
            } else {
                // Deactivating a day
                if (hasProgressOrDependencies(day)) {
                    // Show confirmation dialog
                    const confirmMessage = `Deactivating Day ${day} will:\n` +
                                         `‚Ä¢ Remove any progress on Day ${day}\n` +
                                         `‚Ä¢ Deactivate all subsequent days\n` +
                                         `‚Ä¢ Remove collected runes for affected days\n\n` +
                                         `Are you sure you want to continue?`;
                    
                    if (!confirm(confirmMessage)) {
                        // Revert checkbox
                        event.target.checked = true;
                        return;
                    }
                }
                
                // Deactivate this day and all subsequent days
                deactivateDayAndSubsequent(day);
            }
            
            saveProgress();
            generateScheduleTable();
            updateProgressSummary();
        }

        // Check if a day has progress or dependencies
        function hasProgressOrDependencies(day) {
            // Check if day has any completed tasks
            const hasProgress = progressState.taskCompletions[`day${day}_wells`] || 
                              progressState.taskCompletions[`day${day}_rou`];
            
            // Check if any subsequent days are unlocked
            const hasSubsequentDays = progressState.unlockedDays.some(d => d > day);
            
            return hasProgress || hasSubsequentDays;
        }

        // Deactivate a day and all subsequent days
        function deactivateDayAndSubsequent(startDay) {
            const affectedDays = progressState.unlockedDays.filter(d => d >= startDay);
            
            // Remove from unlocked days
            progressState.unlockedDays = progressState.unlockedDays.filter(d => d < startDay);
            
            // Remove progress for affected days
            affectedDays.forEach(day => {
                delete progressState.taskCompletions[`day${day}_wells`];
                delete progressState.taskCompletions[`day${day}_rou`];
                
                // Remove from completed days
                progressState.completedDays = progressState.completedDays.filter(d => d !== day);
                
                // Remove runes for affected days
                removeRunesForDay(day);
            });
            
            // Update current day
            const maxUnlocked = Math.max(...progressState.unlockedDays, 0);
            progressState.currentDay = maxUnlocked > 0 ? maxUnlocked : 1;
            
            console.log(`Deactivated Days ${startDay}-${Math.max(...affectedDays)} and removed their progress`);
        }

        // Handle completion checkbox changes
        function handleComplete(day, character) {
            const checkbox = event.target;
            progressState.taskCompletions[`day${day}_${character}`] = checkbox.checked;
            
            // Check if both characters completed this day
            const wellsCompleted = progressState.taskCompletions[`day${day}_wells`] || false;
            const rouCompleted = progressState.taskCompletions[`day${day}_rou`] || false;
            
            if (wellsCompleted && rouCompleted) {
                // Mark day as completed
                if (!progressState.completedDays.includes(day)) {
                    progressState.completedDays.push(day);
                    progressState.completedDays.sort((a, b) => a - b);
                    
                    // SILENT RUNE COLLECTION - Add runes when day is completed
                    collectRunesForCompletedDay(day);
                }
                
                // Update current day to next incomplete day
                let nextDay = day + 1;
                while (nextDay <= 40 && progressState.completedDays.includes(nextDay)) {
                    nextDay++;
                }
                progressState.currentDay = nextDay <= 40 ? nextDay : 40;
                
                // Auto-advance unlocked days
                if (!progressState.unlockedDays.includes(nextDay) && nextDay <= 40) {
                    progressState.unlockedDays.push(nextDay);
                    progressState.unlockedDays.sort((a, b) => a - b);
                    console.log(`Day ${day} completed by both! Unlocked Day ${nextDay}`);
                }
            } else {
                // Remove from completed days if unchecked
                if (!checkbox.checked) {
                    progressState.completedDays = progressState.completedDays.filter(d => d !== day);
                    
                    // Remove runes if day is uncompleted
                    removeRunesForDay(day);
                }
            }
            
            saveProgress();
            generateScheduleTable();
            updateProgressSummary();
        }

        // Update progress summary
        function updateProgressSummary() {
            const wellsCount = Object.keys(progressState.taskCompletions).filter(key => 
                key.includes('_wells') && progressState.taskCompletions[key]).length;
            const rouCount = Object.keys(progressState.taskCompletions).filter(key => 
                key.includes('_rou') && progressState.taskCompletions[key]).length;
            
            document.getElementById('wellsProgress').textContent = `${wellsCount}/40`;
            document.getElementById('rouProgress').textContent = `${rouCount}/40`;
            document.getElementById('totalProgress').textContent = progressState.unlockedDays.length;
        }

        // Admin function: Unlock next day
        function unlockNextDay() {
            const maxUnlocked = Math.max(...progressState.unlockedDays);
            if (maxUnlocked < 40) {
                const nextDay = maxUnlocked + 1;
                if (!progressState.unlockedDays.includes(nextDay)) {
                    progressState.unlockedDays.push(nextDay);
                    progressState.unlockedDays.sort((a, b) => a - b);
                    saveProgress();
                    generateScheduleTable();
                    updateProgressSummary();
                    console.log(`Manually unlocked Day ${nextDay}`);
                }
            } else {
                alert('All days are already unlocked!');
            }
        }

        // SILENT RUNE COLLECTION FUNCTIONS
        function collectRunesForCompletedDay(day) {
            const dayData = gameSchedule.schedule.find(d => d.day === day);
            if (!dayData) return;
            
            // Add Wells rune if it exists
            if (dayData.wells.runeDropped) {
                addRuneToCollection('wells', dayData.wells.runeDropped);
            }
            
            // Add Rou rune if it exists
            if (dayData.rou.runeDropped) {
                addRuneToCollection('rou', dayData.rou.runeDropped);
            }
        }
        
        function addRuneToCollection(character, runeName) {
            if (!progressState.collectedRunes) {
                progressState.collectedRunes = { wells: [], rou: [] };
            }
            
            if (!progressState.collectedRunes[character].includes(runeName)) {
                progressState.collectedRunes[character].push(runeName);
                console.log(`Silently collected rune: ${runeName} for ${character}`);
            }
        }
        
        function removeRunesForDay(day) {
            const dayData = gameSchedule.schedule.find(d => d.day === day);
            if (!dayData) return;
            
            // Remove Wells rune if it exists
            if (dayData.wells.runeDropped) {
                progressState.collectedRunes.wells = progressState.collectedRunes.wells.filter(r => r !== dayData.wells.runeDropped);
            }
            
            // Remove Rou rune if it exists
            if (dayData.rou.runeDropped) {
                progressState.collectedRunes.rou = progressState.collectedRunes.rou.filter(r => r !== dayData.rou.runeDropped);
            }
        }

        // Admin function: Reset all progress
        function resetProgress() {
            if (confirm('Are you sure you want to reset all progress? This cannot be undone.')) {
                // Clear localStorage first
                localStorage.removeItem('runeBearer_progress');
                
                // Reset state
                progressState = {
                    currentDay: 1,
                    completedDays: [],
                    unlockedDays: [1],
                    taskCompletions: {},
                    collectedRunes: {
                        wells: [],
                        rou: []
                    }
                };
                
                // Save the reset state
                saveProgress();
                
                // Force update UI
                generateScheduleTable();
                updateProgressSummary();
                
                // Provide feedback
                alert('Progress has been reset to Day 1');
                console.log('Progress reset to Day 1');
                
                // Force reload to ensure clean state
                window.location.reload();
            }
        }

        // Export progress as JSON
        function exportProgress() {
            const dataStr = JSON.stringify(progressState, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = 'rune-bearer-progress.json';
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        }

        // Reset Panel Functions
        function toggleResetPanel() {
            const panel = document.getElementById('resetPanel');
            if (panel.style.display === 'none') {
                panel.style.display = 'block';
                generateResetPanel();
            } else {
                panel.style.display = 'none';
            }
        }

        function generateResetPanel() {
            const container = document.querySelector('.reset-weeks-container');
            container.innerHTML = '';

            // Group days into weeks (8 weeks total for 40 days)
            const weeks = [];
            for (let week = 1; week <= 8; week++) {
                const startDay = (week - 1) * 5 + 1;
                const endDay = Math.min(week * 5, 40);
                weeks.push({
                    week,
                    startDay,
                    endDay,
                    days: Array.from({length: endDay - startDay + 1}, (_, i) => startDay + i)
                });
            }

            weeks.forEach(weekData => {
                const weekElement = document.createElement('div');
                weekElement.className = 'reset-week';
                
                const weekHeader = `
                    <div class="reset-week-header">
                        <div class="reset-week-title">Week ${weekData.week}</div>
                        <div class="reset-week-range">Days ${weekData.startDay}-${weekData.endDay}</div>
                    </div>
                `;

                const daysGrid = weekData.days.map(day => {
                    const dayStatus = getDayResetStatus(day);
                    return `
                        <button class="reset-day-btn ${dayStatus.class}" 
                                onclick="resetIndividualDay(${day})"
                                ${dayStatus.disabled ? 'disabled' : ''}>
                            <div class="day-number">${day}</div>
                            <div class="day-status">${dayStatus.status}</div>
                        </button>
                    `;
                }).join('');

                const weekControls = `
                    <div class="reset-week-controls">
                        <button class="reset-week-btn" onclick="resetWeek(${weekData.week})">
                            Reset Week ${weekData.week}
                        </button>
                    </div>
                `;

                weekElement.innerHTML = `
                    ${weekHeader}
                    <div class="reset-days-grid">
                        ${daysGrid}
                    </div>
                    ${weekControls}
                `;

                container.appendChild(weekElement);
            });
        }

        function getDayResetStatus(day) {
            const isUnlocked = progressState.unlockedDays.includes(day);
            const wellsCompleted = progressState.taskCompletions[`day${day}_wells`] || false;
            const rouCompleted = progressState.taskCompletions[`day${day}_rou`] || false;
            const isCompleted = wellsCompleted || rouCompleted;
            const isFullyCompleted = wellsCompleted && rouCompleted;

            if (!isUnlocked) {
                return {
                    class: 'locked',
                    status: 'Locked',
                    disabled: true
                };
            } else if (isFullyCompleted) {
                return {
                    class: 'completed',
                    status: 'Complete',
                    disabled: false
                };
            } else if (isCompleted) {
                return {
                    class: 'completed',
                    status: 'Partial',
                    disabled: false
                };
            } else {
                return {
                    class: 'unlocked',
                    status: 'Unlocked',
                    disabled: false
                };
            }
        }

        function resetIndividualDay(day) {
            const dayStatus = getDayResetStatus(day);
            
            if (dayStatus.disabled) {
                alert(`Day ${day} is locked and cannot be reset.`);
                return;
            }

            // Check if resetting this day would break progression
            const hasSubsequentUnlocked = progressState.unlockedDays.some(d => d > day);
            const hasSubsequentCompleted = progressState.completedDays.some(d => d > day);
            
            let warningMessage = `Are you sure you want to reset Day ${day}?\n\nThis will:\n- Clear all progress for Day ${day}\n- Remove any runes collected on Day ${day}\n- Reset the day to "never started" state`;
            
            if (hasSubsequentUnlocked || hasSubsequentCompleted) {
                warningMessage += `\n\n‚ö†Ô∏è WARNING: This will also reset all days after Day ${day} to maintain progression logic.`;
            }

            if (confirm(warningMessage)) {
                performDayReset(day);
            }
        }

        function performDayReset(day) {
            console.log(`Resetting Day ${day}...`);
            
            // Remove from unlocked days (and all subsequent days)
            progressState.unlockedDays = progressState.unlockedDays.filter(d => d < day);
            
            // Remove from completed days (current day and all subsequent)
            progressState.completedDays = progressState.completedDays.filter(d => d < day);
            
            // Clear task completions for this day and all subsequent days
            Object.keys(progressState.taskCompletions).forEach(key => {
                const dayMatch = key.match(/day(\d+)_/);
                if (dayMatch && parseInt(dayMatch[1]) >= day) {
                    delete progressState.taskCompletions[key];
                }
            });
            
            // Remove runes for affected days
            for (let d = day; d <= 40; d++) {
                removeRunesForDay(d);
            }
            
            // Update current day
            const maxUnlocked = Math.max(...progressState.unlockedDays, 0);
            progressState.currentDay = maxUnlocked > 0 ? maxUnlocked : 1;
            
            // If we reset Day 1, ensure it's unlocked
            if (day === 1 && !progressState.unlockedDays.includes(1)) {
                progressState.unlockedDays.push(1);
            }
            
            // Save and update UI
            saveProgress();
            generateScheduleTable();
            updateProgressSummary();
            generateResetPanel();
            
            console.log(`Day ${day} reset successfully. Current day is now ${progressState.currentDay}`);
            alert(`Day ${day} has been reset successfully!`);
        }

        function resetWeek(weekNumber) {
            let startDay, endDay;
            
            if (weekNumber === 'current') {
                // Find current week based on current day
                const currentDay = progressState.currentDay;
                const weekNum = Math.ceil(currentDay / 5);
                startDay = (weekNum - 1) * 5 + 1;
                endDay = Math.min(weekNum * 5, 40);
            } else {
                startDay = (weekNumber - 1) * 5 + 1;
                endDay = Math.min(weekNumber * 5, 40);
            }
            
            const weekText = weekNumber === 'current' ? 'current week' : `Week ${weekNumber}`;
            
            if (confirm(`Are you sure you want to reset ${weekText} (Days ${startDay}-${endDay})?\n\nThis will reset all progress for these days and may affect subsequent days to maintain progression logic.`)) {
                performDayReset(startDay);
            }
        }

        function resetAllProgress() {
            if (confirm('Are you sure you want to reset ALL progress? This will clear everything and cannot be undone.')) {
                resetProgress();
                generateResetPanel();
            }
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case 'u':
                        e.preventDefault();
                        unlockNextDay();
                        break;
                    case 'r':
                        e.preventDefault();
                        if (e.shiftKey) {
                            resetProgress();
                        }
                        break;
                    case 't':
                        e.preventDefault();
                        toggleResetPanel();
                        break;
                }
            }
        });
    </script>
</body>
</html> 